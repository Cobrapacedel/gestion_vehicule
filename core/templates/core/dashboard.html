{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto mt-6 px-4">
    <!-- Profil utilisateur -->
<div class="flex items-center space-x-4">
    {% load user_badges %}
    {% if user.profile.avatar and user.profile.avatar.url %}
        <img src="{{ user.profile.avatar.url }}" alt="Avatar de {{ user.first_name }}"
             class="rounded-full w-24 h-24 border shadow">
    {% else %}
        <img src="{% static 'avatars/default.png' %}" alt="Avatar par dÃ©faut"
             class="rounded-full w-24 h-24 border shadow">
    {% endif %}
    <div class="flex flex-col">
        <span class="text-xl font-semibold">{{ user.first_name }} {{ user.last_name }}</span>
        <!-- ğŸ”¹ Badges utilisateurs -->
        {% user_badges user %}
    </div>
</div>

    <h2 class="text-2xl font-bold mt-6">ğŸ‘‹ Byenvini</h2>
    <p class="text-center text-blue-600 font-semibold">{{ user.email }}</p>

    <!-- Cartes d'informations -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
        <!-- Soldes -->
        <div class="bg-blue-600 text-white rounded-xl shadow p-4">
            <h5 class="text-lg font-bold">ğŸ’° Kont ou yo</h5>
            <p class="mt-2">ğŸ“¢ Ou gen <strong>{{ solde_total_htg|floatformat:2 }} HTG</strong> sou kont ou.</p>
            <ul class="list-disc list-inside text-sm mt-2">
                <li>HTG : {{ solde_htg|floatformat:2 }}</li>
                <li>USD : {{ solde_usd|floatformat:2 }}</li>
                <li>BTG : {{ solde_btg|floatformat:2 }}</li>
            </ul>
            <a href="{% url 'payments:transaction_list' %}" class="mt-3 inline-block bg-white text-black px-4 py-2 rounded font-semibold hover:bg-gray-100">
                ğŸ’³ Lis tout tranzaksyon ou yo
            </a>
        </div>

        <!-- VÃ©hicules -->
        <div class="bg-green-600 text-white rounded-xl shadow p-4">
            <h5 class="text-lg font-bold">ğŸš— Machin ou yo</h5>
            <p class="mt-2">ğŸ“¢ Ou gen <strong>{{ nombre_vehicules }}</strong> machin sou kont ou.</p>
            <a href="{% url 'vehicles:vehicles_list' %}" class="mt-3 inline-block bg-white text-black px-4 py-2 rounded font-semibold hover:bg-gray-100">
                ğŸ“œ Lis tout machin ou yo
            </a>
        </div>

        <!-- Documents -->
        <div class="bg-pink-600 text-white rounded-xl shadow p-4">
            <h5 class="text-lg font-bold">ğŸ“„ Dokiman ou yo</h5>
            <p class="mt-2">ğŸ“¢ Ou gen <strong>{{ documents }}</strong> dokiman.</p>
            <a href="{% url 'documents:document_list' %}" class="mt-3 inline-block bg-white text-black px-4 py-2 rounded font-semibold hover:bg-gray-100">
                ğŸ“œ Lis tout dokiman ou yo
            </a>
        </div>

        <!-- PÃ©ages -->
        <div class="bg-orange-600 text-white rounded-xl shadow p-4">
            <h5 class="text-lg font-bold">ğŸ›£ï¸ Pwen Peyaj</h5>
            <p class="mt-2">ğŸ“¢ Ou gen <strong>{{ tolls }}</strong> peyaj sou kont ou.</p>
            <a href="{% url 'tolls:toll_list' %}" class="mt-3 inline-block bg-white text-black px-4 py-2 rounded font-semibold hover:bg-gray-100">
                ğŸ“œ Lis tout pwen peyaj ou yo
            </a>
        </div>

        <!-- Notifications -->
        <div class="bg-yellow-500 text-white rounded-xl shadow p-4">
            <h5 class="text-lg font-bold">ğŸ”” Notifikasyon ou yo</h5>
            <p class="mt-2">ğŸ“¢ Ou gen <strong>{{ notifications }}</strong> nouvo notifikasyon.</p>
            <a href="{% url 'notifications:notification_list' %}" class="mt-3 inline-block bg-white text-black px-4 py-2 rounded font-semibold hover:bg-gray-100">
                ğŸ“© WÃ¨ notifikasyon yo
            </a>
        </div>

        <!-- Contraventions -->
        <div class="bg-red-600 text-white rounded-xl shadow p-4">
            <h5 class="text-lg font-bold">ğŸš¨ Kontravansyon ou yo</h5>
            <p class="mt-2">ğŸ“¢ Ou gen <strong>{{ fines }}</strong> nouvo kontravansyon.</p>
            <a href="{% url 'fines:fine_list' %}" class="mt-3 inline-block bg-white text-black px-4 py-2 rounded font-semibold hover:bg-gray-100">
                âš–ï¸ WÃ¨ tout kontravansyon yo
            </a>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="bg-gray rounded-xl shadow p-6 mt-6 border border-gray-200">
        <h5 class="text-lg font-bold mb-4">ğŸ“Š Statistik tranzaksyon chak mwa</h5>
        <canvas id="transactionsChart" height="100"></canvas>
    </div>

    <!-- Preferans Notifications -->
    <div class="bg-gray-300 rounded-lg shadow p-6 mt-6">
        <h2 class="text-xl font-bold mb-4 text-white">ğŸ”” Preferans Notifikasyon</h2>

        <!-- Email -->
        <div id="email-toggle" class="mb-3">
            <form hx-post="{% url 'users:toggle_email_notifications' %}" hx-swap="outerHTML" hx-target="#email-toggle">
                <strong class="text-black">ImÃ¨l Notifikasyon:</strong>
                <button type="submit" class="px-4 py-1 rounded-full flex items-center
                    {% if profile.email_notifications %}bg-green-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                    {% if profile.email_notifications %}
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
                        </svg> Aktive
                    {% else %}
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
                        </svg> Dezaktive
                    {% endif %}
                </button>
            </form>
        </div>

        <!-- SMS -->
        <div id="sms-toggle">
            <form hx-post="{% url 'users:toggle_sms_notifications' %}" hx-swap="outerHTML" hx-target="#sms-toggle">
                <strong class="text-black">SMS Notifikasyon:</strong>
                <button type="submit" class="px-4 py-1 rounded-full flex items-center
                    {% if profile.sms_notifications %}bg-green-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                    {% if profile.sms_notifications %}
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
                        </svg> Aktive
                    {% else %}
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
                        </svg> Dezaktive
                    {% endif %}
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('transactionsChart').getContext('2d');
const transactionsChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ labels|safe }},
        datasets: [{
            label: 'Montant total HTG',
            data: {{ data|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            borderRadius: 8
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                ticks: { callback: value => value + ' HTG' }
            }
        }
    }
});
</script>
{% endblock %}
