{% extends 'core/base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded shadow">

  <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">
    Nouvo Kontravansyon
  </h2>

  <form method="post">
    {% csrf_token %}

    <!-- ===================== -->
    <!-- CHAUFFEUR (PERMIS) -->
    <!-- ===================== -->
    <label for="id_driver_license_number" class="block text-sm font-medium">
      Nimewo Lisans
    </label>

    <input
      type="text"
      name="driver_license_number"
      id="id_driver_license_number"
      hx-get="{% url 'fines:htmx_driver_lookup' %}"
      hx-trigger="keyup changed delay:500ms"
      hx-target="#driver-result"
      hx-swap="innerHTML"
      class="w-full mt-1 p-2 rounded border"
      required
    >
    <div id="driver-result" class="mt-2 text-sm text-gray-600"></div>

    <!-- ===================== -->
    <!-- PROPRIÉTAIRE -->
    <!-- ===================== -->
    <label class="block text-sm font-medium mt-4">
      Pwopriyetè
    </label>

    <input
      type="text"
      name="owner_query"
      id="id_owner_query"
      hx-get="{% url 'fines:htmx_owner_lookup' %}"
      hx-trigger="keyup changed delay:500ms"
      hx-target="#owner-result"
      hx-swap="innerHTML"
      class="w-full mt-1 p-2 rounded border"
      placeholder="Nom, prénom ou raison sociale"
      autocomplete="off"
      required
    >

    <div id="owner-result" class="mt-2"></div>

    <!-- Champs cachés pour owner_type et owner_id -->
    <input type="hidden" id="id_owner_type" name="owner_type" required>
    <input type="hidden" id="id_owner_id" name="owner_id" required>

    <!-- ===================== -->
    <!-- VÉHICULE (HTMX) -->
    <!-- ===================== -->
    <div id="vehicle-container" class="mt-4">
      <!-- HTMX injectera ici le select véhicule -->
    </div>

    <!-- ===================== -->
    <!-- INFRACTION -->
    <!-- ===================== -->
    <label for="id_violation" class="block text-sm font-medium mt-4">
      Infraction
    </label>
    {{ form.violation }}

    <!-- ===================== -->
    <!-- ACTIONS -->
    <!-- ===================== -->
    <div class="flex justify-between mt-6">
      <button
        type="submit"
        id="submit_btn"
        class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700 transition"
        disabled
      >
        Kreye
      </button>

      <a
        href="{% url 'fines:fine_list' %}"
        class="bg-gray-200 text-gray-700 px-5 py-2 rounded hover:bg-gray-300 transition"
      >
        Tounen
      </a>
    </div>

  </form>
</div>

<script>
  //  Activer le bouton submit seulement si un propriétaire est choisi
  function activateSubmit() {
    document.getElementById('submit_btn').disabled = false;
  }

  // Mettre à jour owner_type et owner_id et charger les véhicules via HTMX
  function selectOwner(type, id, name) {
    document.getElementById('id_owner_type').value = type;
    document.getElementById('id_owner_id').value = id;
    document.getElementById('id_owner_query').value = name;

    // Charger les véhicules du propriétaire
    const url = "{% url 'vehicles:htmx_owner_vehicles' %}?owner_type=" + type + "&owner_id=" + id;
    fetch(url)
      .then(resp => resp.text())
      .then(html => {
        document.getElementById('vehicle-container').innerHTML = html;
      });

    activateSubmit();
  }
</script>
{% endblock %}